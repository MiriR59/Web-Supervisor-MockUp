<div class="source-readings">

    <button (click)="setWindow('5m')" [class.active]="currentWindow() === '5m'">5 mins</button>
    <button (click)="setWindow('15m')" [class.active]="currentWindow() === '15m'">15 mins</button>
    <button (click)="setWindow('all')" [class.active]="currentWindow() === 'all'">All</button>
        @let enabled = (enabled$ | async);
        <button
            *ngIf="authService.canToggleSources()"
            (click)="toggleEnabled(enabled ?? false)"
            [disabled]="isApplying()"
            [class.enable]="!enabled"
            [class.disable]="enabled">
            {{ enabled ? 'Disable' : 'Enable '}}
        </button>

    <span *ngIf="isApplying()" class="applying-indicator">
        Applying change...
    </span>

    <div class="lag-badge" *ngIf="lag$ | async as lag">
        <ng-container *ngIf="lag.state === 'Ok'; else lagNotOk">
            <div class="lag-main">
                <span class="lag-label">DB is</span>
                <span class="lag-value">{{ lag.dbLag | number:'1.0-0' }}</span>
                <span class="lag-unit">seconds behind</span>
            </div>

            <div class="lag-details">
                <div class="lag-row">
                    <span class="k">Generated:</span>
                    <span class="v">{{ lag.latestGenerated | date:'HH:mm:ss' }}</span>
                </div>

                <div class="lag-row">
                    <span class="k">Persisted:</span>
                    <span class="v">{{ lag.latestDb | date:'HH:mm:ss' }}</span>
                </div>
            </div>
        </ng-container>

        <ng-template #lagNotOk>
            <div *ngIf="lag.state === 'NoLiveData'" class="lag-main">
                <span class="lag-label">No live data</span>
            </div>

            <div *ngIf="lag.state === 'DbEmpty'">
                <div class="lag-main">
                    <span class="lag-label">DB empty</span>
                </div>

                <div class="lag-details">
                    <div class="lag-row">
                        <span class="k">Generated:</span>
                        <span class="v">{{ lag.latestGenerated | date:'HH:mm:ss' }}</span>
                    </div>
                </div>
            </div>
        </ng-template>
    </div>

    <div *ngIf="readings$ | async as readings; else loading" class="content-grid">
        <div class="panel panel-table">
            <div class="panel-title">Readings</div>

            <div *ngIf="readings.length === 0">No readings yet.</div>

            <div *ngIf="readings.length > 0" class="table-scroll">
                <table class="readings-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th class="num">RPM</th>
                            <th class="num">Power</th>
                            <th class="num">Temperature</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr *ngFor="let r of readings">
                            <td>{{ r.timestamp | date:'HH:mm:ss' }}</td>
                            <td class="num">{{ r.rpm }}</td>
                            <td class="num">{{ r.power }}</td>
                            <td class="num">{{ r.temperature | number: '1.1-1' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="panel panel-chart">
            <div class="panel-title">RPM</div>

            @if (rpmOptions$ | async; as opt) {
                <div class="chart-slot" echarts [options]="opt"></div>
            }
            @else {
                <div class="chart-placeholder">Loading chart...</div>
            }
        </div>

        <div class="panel panel-chart">
            <div class="panel-title">Power</div>

            @if (powerOptions$ | async; as opt) {
                <div class="chart-slot" echarts [options]="opt"></div>
            }
            @else {
                <div class="chart-placeholder">Loading chart...</div>
            }
        </div>

        <div class="panel panel-chart">
            <div class="panel-title">Temperature</div>

            @if (tempOptions$ | async; as opt) {
                <div class="chart-slot" echarts [options]="opt"></div>
            }
            @else {
                <div class="chart-placeholder">Loading chart...</div>
            }
        </div>
    </div>

    <ng-template #loading>
        Loading readings...
    </ng-template>
</div>